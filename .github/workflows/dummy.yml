name: Build and release Git-Mastery CLI

on:
  workflow_run:
    workflows:
      - Bump version tag on merge
    types:
      - completed
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  pull-requests: write
  packages: read
  issues: read

jobs:
  prepare:
    uses: git-mastery/actions/.github/workflows/get-latest-tag.yml@main

  arch-build:
    needs: prepare
    if: needs.prepare.outputs.should_publish == 'true'

    runs-on: ubuntu-latest

    env:
      ARCHITECTURE: amd64
      VERSION_NUMBER: ${{ needs.prepare.outputs.version_number }}
      FILENAME: gitmastery-${{ needs.prepare.outputs.version_number }}-arch-amd64
      REF_NAME: ${{ needs.prepare.outputs.ref_name }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v6

      - name: Build binary
        run: |
          # Generate the .SRCINFO within a Docker container
          # We attach the current directory (aur-pkg) as the pkg directory volume
          echo "__version__ = \"$REF_NAME\"" > app/version.py

          docker run --rm \
            -v $PWD:/pkg \
            archlinux:base-devel \
            bash -c "
              pacman -Sy --noconfirm python pyinstaller openssl git &&
              cd /app &&
              pyinstaller --onefile main.py --name $FILENAME --distpath /pkg/dist
            "

          # Fix file ownership after Docker run
          sudo chown -R $(id -u):$(id -g) .

          tree
